# vision_pub.py é‡æ„å‰åå¯¹æ¯”

## ğŸ“Š æ¶æ„å¯¹æ¯”

### âŒ é‡æ„å‰ï¼ˆå•æ‘„åƒå¤´ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä¸»çº¿ç¨‹ (run)             â”‚
â”‚                                 â”‚
â”‚  ç›´æ¥è°ƒç”¨ camera_worker(cam_idx) â”‚
â”‚         â†“                       â”‚
â”‚  while True:                    â”‚
â”‚    - è¯»å–å›¾åƒ                    â”‚
â”‚    - YOLO æ£€æµ‹                  â”‚
â”‚    - ç¯è¯­è¯†åˆ«                    â”‚
â”‚    - socket.send_string() âœ…    â”‚
â”‚    - print() âœ…                 â”‚
â”‚                                 â”‚
â”‚  âš ï¸ ä¸»çº¿ç¨‹è¢«å æ»¡ï¼Œæ— æ³•å¤„ç†å…¶ä»–æ‘„åƒå¤´ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜ï¼š**
- âŒ åªæ”¯æŒå•æ‘„åƒå¤´
- âŒ ä¸»çº¿ç¨‹è¢« camera_worker å æ»¡
- âŒ æ— æ³•å¹¶è¡Œå¤„ç†å¤šä¸ªæ‘„åƒå¤´
- âŒ æ‰©å±•æ€§å·®

---

### âœ… é‡æ„åï¼ˆ4æ‘„åƒå¤´å¹¶è¡Œï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸»çº¿ç¨‹ (æ¶ˆè´¹è€…)                        â”‚
â”‚  1. å¯åŠ¨ 4 ä¸ªç”Ÿäº§è€…çº¿ç¨‹                                   â”‚
â”‚  2. while True:                                         â”‚
â”‚       data = queue.get()  â† ä»é˜Ÿåˆ—å–æ•°æ®                 â”‚
â”‚       socket.send_string() âœ…  â† ä¸»çº¿ç¨‹ç»Ÿä¸€å‘é€           â”‚
â”‚       print() âœ…  â† ä¸»çº¿ç¨‹ç»Ÿä¸€æ‰“å°                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘
                           â”‚ queue.get()
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  queue.Queue(maxsize=100) â”‚
              â”‚    (çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—)          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ queue.put_nowait()
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”Ÿäº§è€…çº¿ç¨‹1  â”‚  ç”Ÿäº§è€…çº¿ç¨‹2  â”‚  ç”Ÿäº§è€…çº¿ç¨‹3  â”‚  ç”Ÿäº§è€…çº¿ç¨‹4  â”‚
â”‚  Camera 0    â”‚  Camera 2    â”‚  Camera 4    â”‚  Camera 6    â”‚
â”‚  (åæ–¹)      â”‚  (å³ä¾§)      â”‚  (å‰æ–¹)      â”‚  (å·¦ä¾§)      â”‚
â”‚              â”‚              â”‚              â”‚              â”‚
â”‚  while True: â”‚  while True: â”‚  while True: â”‚  while True: â”‚
â”‚  - è¯»å›¾      â”‚  - è¯»å›¾      â”‚  - è¯»å›¾      â”‚  - è¯»å›¾      â”‚
â”‚  - YOLO      â”‚  - YOLO      â”‚  - YOLO      â”‚  - YOLO      â”‚
â”‚  - ç¯è¯­      â”‚  - ç¯è¯­      â”‚  - ç¯è¯­      â”‚  - ç¯è¯­      â”‚
â”‚  - æ”¾é˜Ÿåˆ— âœ…  â”‚  - æ”¾é˜Ÿåˆ— âœ…  â”‚  - æ”¾é˜Ÿåˆ— âœ…  â”‚  - æ”¾é˜Ÿåˆ— âœ…  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ”¯æŒ 4 ä¸ªæ‘„åƒå¤´å¹¶è¡Œ
- âœ… ä¸»çº¿ç¨‹ä¸“æ³¨äºæ¶ˆè´¹å’Œå‘é€
- âœ… ç”Ÿäº§è€…çº¿ç¨‹ç‹¬ç«‹å·¥ä½œ
- âœ… çº¿ç¨‹å®‰å…¨ï¼Œæ˜“äºæ‰©å±•

---

## ğŸ”§ ä»£ç å¯¹æ¯”

### 1. å¯¼å…¥æ¨¡å—

#### âŒ é‡æ„å‰
```python
import cv2
import numpy as np
import time
import math
import json
import zmq
from collections import defaultdict
from ultralytics import YOLO
```

#### âœ… é‡æ„å
```python
import cv2
import numpy as np
import time
import math
import json
import zmq
import queue       # â† æ–°å¢
import threading   # â† æ–°å¢
from collections import defaultdict
from ultralytics import YOLO
```

---

### 2. åˆå§‹åŒ–

#### âŒ é‡æ„å‰
```python
def __init__(self, model_path, camera_indices=[0, 2, 4, 6], zmq_port=5555):
    # ...
    self.detection_buffer = defaultdict(list)
    
    # åˆå§‹åŒ– ZeroMQ
    self.context = zmq.Context()
    self.socket = self.context.socket(zmq.PUB)
    self.socket.bind(f"tcp://*:{self.zmq_port}")
```

#### âœ… é‡æ„å
```python
def __init__(self, model_path, camera_indices=[0, 2, 4, 6], zmq_port=5555):
    # ...
    self.detection_buffer = defaultdict(list)
    
    # çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼ˆç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼‰â† æ–°å¢
    self.queue = queue.Queue(maxsize=100)
    
    # åˆå§‹åŒ– ZeroMQ
    self.context = zmq.Context()
    self.socket = self.context.socket(zmq.PUB)
    self.socket.bind(f"tcp://*:{self.zmq_port}")
```

---

### 3. camera_worker æ–¹æ³•

#### âŒ é‡æ„å‰ï¼ˆç›´æ¥å‘é€ï¼‰
```python
def camera_worker(self, cam_idx):
    # ...
    while True:
        # æ£€æµ‹é€»è¾‘
        detection_data = {
            'distance': float(distance),
            'bearing_body': float(bearing_body),
            # ...
        }
        
        # âŒ ç›´æ¥åœ¨å­çº¿ç¨‹ä¸­å‘é€ ZMQï¼ˆä¸å®‰å…¨ï¼‰
        self.publish_detection(detection_data)

def publish_detection(self, data):
    # âŒ ç›´æ¥æ“ä½œ socketï¼ˆä¸å®‰å…¨ï¼‰
    self.socket.send_string(f"perception {json.dumps(data)}")
    # âŒ ç›´æ¥æ‰“å°ï¼ˆå¤šçº¿ç¨‹æ—¥å¿—æ··ä¹±ï¼‰
    print(f"ğŸ¥ [Cam{cam_idx}] Sent: ...")
```

#### âœ… é‡æ„åï¼ˆæ”¾å…¥é˜Ÿåˆ—ï¼‰
```python
def camera_worker(self, cam_idx):
    # ...
    while True:
        # æ£€æµ‹é€»è¾‘
        detection_data = {
            'type': 'detection',  # â† æ–°å¢ç±»å‹å­—æ®µ
            'distance': float(distance),
            'bearing_body': float(bearing_body),
            # ...
        }
        
        # âœ… æ”¾å…¥é˜Ÿåˆ—ï¼Œä¸ç›´æ¥å‘é€
        try:
            self.queue.put_nowait(detection_data)
        except queue.Full:
            pass  # é˜Ÿåˆ—æ»¡äº†ï¼Œä¸¢å¼ƒè¯¥å¸§

# âœ… åˆ é™¤äº† publish_detection æ–¹æ³•
```

---

### 4. run æ–¹æ³•

#### âŒ é‡æ„å‰ï¼ˆå•æ‘„åƒå¤´ï¼‰
```python
def run(self):
    """è¿è¡Œè§†è§‰å‘å¸ƒè€…ï¼ˆå•æ‘„åƒå¤´æ¨¡å¼ï¼‰"""
    if len(self.camera_indices) == 1:
        # âŒ ç›´æ¥è°ƒç”¨ï¼Œä¸»çº¿ç¨‹è¢«å æ»¡
        self.camera_worker(self.camera_indices[0])
    else:
        print("âš ï¸ å¤šæ‘„åƒå¤´æ¨¡å¼éœ€è¦ä½¿ç”¨å¤šè¿›ç¨‹ï¼Œå½“å‰ä»…æ”¯æŒå•æ‘„åƒå¤´")
```

#### âœ… é‡æ„åï¼ˆå¤šæ‘„åƒå¤´å¹¶è¡Œï¼‰
```python
def run(self):
    """è¿è¡Œè§†è§‰å‘å¸ƒè€…ï¼ˆå¤šæ‘„åƒå¤´å¹¶è¡Œæ¨¡å¼ï¼‰"""
    # âœ… å¯åŠ¨æ‰€æœ‰æ‘„åƒå¤´çš„ç”Ÿäº§è€…çº¿ç¨‹
    threads = []
    for cam_idx in self.camera_indices:
        thread = threading.Thread(
            target=self.camera_worker,
            args=(cam_idx,),
            daemon=True,
            name=f"Camera-{cam_idx}"
        )
        thread.start()
        threads.append(thread)
    
    # âœ… ä¸»çº¿ç¨‹ä½œä¸ºæ¶ˆè´¹è€…ï¼Œä¸æ–­ä»é˜Ÿåˆ—å–æ•°æ®
    try:
        while True:
            data = self.queue.get()
            
            if data.get('type') == 'log':
                print(data['message'])
            
            elif data.get('type') == 'detection':
                # âœ… ä¸»çº¿ç¨‹ç»Ÿä¸€å‘é€ ZMQ
                detection_data = {k: v for k, v in data.items() if k != 'type'}
                message = json.dumps(detection_data)
                self.socket.send_string(f"perception {message}")
                
                # âœ… ä¸»çº¿ç¨‹ç»Ÿä¸€æ‰“å°æ—¥å¿—
                if detection_data['command'] != 'IDLE':
                    print(f"ğŸ¥ [Cam{cam_idx}] Sent: ...")
            
            self.queue.task_done()
    
    except KeyboardInterrupt:
        for thread in threads:
            thread.join(timeout=5.0)
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| æ”¯æŒæ‘„åƒå¤´æ•° | 1 | 4 |
| å¹¶è¡Œå¤„ç† | âŒ | âœ… |
| çº¿ç¨‹å®‰å…¨ | âš ï¸ | âœ… |
| ZMQ å‘é€ | å­çº¿ç¨‹ï¼ˆä¸å®‰å…¨ï¼‰ | ä¸»çº¿ç¨‹ï¼ˆå®‰å…¨ï¼‰ |
| æ—¥å¿—æ‰“å° | å¤šçº¿ç¨‹æ··ä¹± | ä¸»çº¿ç¨‹ç»Ÿä¸€ |
| é˜Ÿåˆ—ç¼“å†² | âŒ | âœ… (100) |
| ä¸¢å¸§ç­–ç•¥ | âŒ | âœ… |
| æ‰©å±•æ€§ | å·® | å¥½ |

---

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹

### 1. çº¿ç¨‹å®‰å…¨
- **é‡æ„å‰**: å¤šä¸ªçº¿ç¨‹ç›´æ¥æ“ä½œ ZMQ Socketï¼ˆä¸å®‰å…¨ï¼‰
- **é‡æ„å**: åªæœ‰ä¸»çº¿ç¨‹æ“ä½œ Socketï¼ˆå®‰å…¨ï¼‰

### 2. å¹¶è¡Œèƒ½åŠ›
- **é‡æ„å‰**: å•æ‘„åƒå¤´ï¼Œä¸²è¡Œå¤„ç†
- **é‡æ„å**: 4æ‘„åƒå¤´ï¼Œå¹¶è¡Œå¤„ç†

### 3. è§£è€¦è®¾è®¡
- **é‡æ„å‰**: camera_worker è´Ÿè´£æ£€æµ‹ + å‘é€ + æ‰“å°
- **é‡æ„å**: camera_worker åªè´Ÿè´£æ£€æµ‹ï¼Œä¸»çº¿ç¨‹è´Ÿè´£å‘é€å’Œæ‰“å°

### 4. é˜Ÿåˆ—ç¼“å†²
- **é‡æ„å‰**: æ— ç¼“å†²ï¼Œç›´æ¥å‘é€
- **é‡æ„å**: 100ä¸ªæ¶ˆæ¯çš„ç¼“å†²åŒºï¼Œå¹³æ»‘çªå‘æµé‡

### 5. ä¸¢å¸§ç­–ç•¥
- **é‡æ„å‰**: æ— ä¸¢å¸§æœºåˆ¶
- **é‡æ„å**: é˜Ÿåˆ—æ»¡æ—¶è‡ªåŠ¨ä¸¢å¼ƒï¼Œä¿è¯å®æ—¶æ€§

---

## ğŸš€ è¿ç§»æŒ‡å—

å¦‚æœä½ æœ‰æ—§ç‰ˆæœ¬çš„ä»£ç ï¼Œåªéœ€è¦ï¼š

1. **æ›´æ–° CAMERA_INDICES**
   ```python
   # æ—§ç‰ˆæœ¬
   CAMERA_INDICES = [4]  # å•æ‘„åƒå¤´
   
   # æ–°ç‰ˆæœ¬
   CAMERA_INDICES = [0, 2, 4, 6]  # 4æ‘„åƒå¤´
   ```

2. **è¿è¡Œæ–°ç‰ˆæœ¬**
   ```bash
   python3 vision_pub.py
   ```

3. **æ— éœ€ä¿®æ”¹è®¢é˜…è€…ä»£ç **
   - ZMQ æ¶ˆæ¯æ ¼å¼ä¿æŒä¸å˜
   - è®¢é˜…è€…æ— éœ€ä»»ä½•ä¿®æ”¹

---

**é‡æ„å®Œæˆï¼** ğŸ‰ ç°åœ¨å¯ä»¥äº«å— 4 æ‘„åƒå¤´å¹¶è¡Œå¤„ç†çš„å¼ºå¤§èƒ½åŠ›äº†ï¼

